<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OKX Êô∫ÊÖßÂÅµÊ∏¨‰∫§ÊòìÊ©üÂô®‰∫∫ v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --success: #2ea043;
            --danger: #da3633;
            --warning: #d29922;
            --border: #30363d;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(90deg, #58a6ff, #a371f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .version-tag {
            background: rgba(88, 166, 255, 0.15);
            color: var(--accent);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
            vertical-align: middle;
            border: 1px solid rgba(88, 166, 255, 0.3);
        }

        /* GRID LAYOUT */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card h3 {
            margin: 0;
            font-size: 15px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* CONTROLS */
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        select, button {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: #21262d;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        select:focus, button:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-start {
            background: var(--success);
            color: white;
            border: none;
            font-weight: bold;
        }
        .btn-start:hover { background: #3fb950; }

        .btn-stop {
            background: var(--danger);
            color: white;
            border: none;
            font-weight: bold;
        }
        .btn-stop:hover { background: #f85149; }

        .btn-action {
             background: rgba(56, 139, 253, 0.15);
             color: var(--accent);
             border: 1px solid rgba(56, 139, 253, 0.4);
             padding: 4px 10px;
             font-size: 12px;
        }
        .btn-action:hover { background: rgba(56, 139, 253, 0.3); }

        /* TABLES & LISTS */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; color: var(--text-secondary); font-weight: normal; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        td { padding: 10px 0; border-bottom: 1px solid #21262d; font-family: 'JetBrains Mono', monospace; }
        
        .pnl-positive { color: var(--success); }
        .pnl-negative { color: var(--danger); }

        .scanner-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #21262d;
        }
        .scanner-item:last-child { border-bottom: none; }
        
        .change-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* LOGS */
        .logs {
            background: #0d1117;
            padding: 15px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border);
            color: #8b949e;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            header { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div style="display: flex; align-items: center;">
                <h1>OKX Êô∫ÊÖßÂÅµÊ∏¨‰∫§ÊòìÊ©üÂô®‰∫∫</h1>
                <span class="version-tag">v2.0</span>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div id="clock" style="font-family: 'JetBrains Mono'; font-weight: bold; color: var(--text-secondary);">--:--:--</div>
                <div id="statusBadge" style="padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #21262d;">Connecting...</div>
            </div>
        </header>

        <!-- CONTROL PANEL -->
        <div class="grid" style="grid-template-columns: 350px 1fr;">
            <div class="card">
                <div class="card-header">
                    <h3>Êìç‰ΩúÈù¢Êùø (Control)</h3>
                    <span id="botState" style="color: var(--danger); font-weight: bold;">üî¥ Â∑≤ÂÅúÊ≠¢</span>
                </div>
                
                <div class="control-group">
                    <label>‰∫§ÊòìÊ®°Âºè (Mode)</label>
                    <select id="modeSelect" onchange="updateModeUI()">
                        <option value="SINGLE">ÂñÆÂπ£ÁãôÊìä (Single Mode)</option>
                        <option value="DUAL">ÈõôÂπ£Â∞çÊ≤ñ (Dual Mode)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>‰∏ªÂπ£Á®Æ (Primary Coin)</label>
                    <select id="symbol1">
                        <option value="BTC/USDT">BTC/USDT (Á©©ÂÅ•)</option>
                        <option value="ETH/USDT">ETH/USDT (‰∏ªÊµÅ)</option>
                        <option value="ETC/USDT">ETC/USDT (Ê≥¢Âãï)</option>
                        <option value="SOL/USDT">SOL/USDT (ÁÜ±ÈñÄ)</option>
                        <option value="DOGE/USDT">DOGE/USDT (Meme)</option>
                    </select>
                </div>

                <div class="control-group" id="symbol2-group" style="display: none;">
                    <label>ÂâØÂπ£Á®Æ (Secondary Coin)</label>
                    <select id="symbol2">
                        <option value="ETH/USDT">ETH/USDT</option>
                        <option value="ETC/USDT" selected>ETC/USDT</option>
                        <option value="SOL/USDT">SOL/USDT</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-start" onclick="startBot()">ÂïüÂãïÊ©üÂô®‰∫∫ (Start)</button>
                    <button class="btn-stop" onclick="stopBot()">ÂÅúÊ≠¢ (Stop)</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Ë≥áÁî¢Ê¶ÇÊ≥Å (Portfolio)</h3>
                    <div style="text-align: right;">
                        <span style="font-size: 12px; color: var(--text-secondary);">Â∏≥Êà∂Ê∑®ÂÄº (Est. NAV)</span>
                        <div id="nav-val" style="font-size: 18px; font-weight: bold;">-- USDT</div>
                    </div>
                </div>
                <div style="display: flex; gap: 40px;">
                    <div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Á∏ΩÁõàËôß (Total PnL)</div>
                        <div id="pnl-val" class="stat-value">--</div>
                        <div id="pnl-pct" style="font-size: 14px; font-weight: bold; margin-top: 5px;">0.00%</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: var(--text-secondary);">‰ªäÊó•Â∑≤ÂØ¶Áèæ (Daily Realized)</div>
                        <div id="daily-pnl" class="stat-value" style="font-size: 24px;">--</div>
                    </div>
                    <div style="margin-left: auto; text-align: right;">
                         <div style="font-size: 12px; color: var(--text-secondary);">USDT È§òÈ°ç</div>
                         <div id="bal-usdt" style="font-size: 20px; font-family: 'JetBrains Mono';">--</div>
                    </div>
                </div>
                <div style="height: 180px; margin-top: 15px;">
                    <canvas id="pnlChart"></canvas>
                </div>
            </div>
        </div>

        <!-- SCANNER & ACTIVE PAIRS -->
        <div class="grid">
            <!-- Active Strategies -->
            <div class="card">
                <h3>Ê¥ªË∫çÁ≠ñÁï•Áõ£Êéß (Active Strategies)</h3>
                <div id="strategy-container" style="margin-top: 15px;">
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        Á≠âÂæÖÂïüÂãï...
                    </div>
                </div>
            </div>

            <!-- Market Scanner -->
            <div class="card">
                <div class="card-header">
                    <h3>üî• Â∏ÇÂ†¥ÊéÉÊèèÂô® (Hot Coins)</h3>
                    <span style="font-size: 10px; background: #238636; padding: 2px 6px; border-radius: 4px;">LIVE</span>
                </div>
                <div id="scanner-list" style="height: 300px; overflow-y: auto;">
                    <!-- Scanner Items -->
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">Scanning...</div>
                </div>
            </div>
        </div>

        <!-- LOGS & TRADES -->
        <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <div class="card">
                <h3>ÊúÄËøë‰∫§Êòì (Recent Trades)</h3>
                <div style="height: 250px; overflow-y: auto;">
                    <table id="trades-table">
                        <thead>
                            <tr>
                                <th>ÊôÇÈñì</th>
                                <th>Âπ£Á®Æ</th>
                                <th>ÊñπÂêë</th>
                                <th>ÂÉπÊ†º</th>
                                <th>Êï∏Èáè</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h3>Á≥ªÁµ±Êó•Ë™å (System Logs)</h3>
                <div id="log-console" class="logs">
                    [System] Ready to trade. Select mode and start.
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        let pnlChart;
        
        // UI Helpers
        function updateModeUI() {
            const mode = document.getElementById('modeSelect').value;
            const group2 = document.getElementById('symbol2-group');
            if (mode === 'DUAL') {
                group2.style.display = 'block';
            } else {
                group2.style.display = 'none';
            }
        }

        function log(msg) {
            const c = document.getElementById('log-console');
            const d = new Date().toLocaleTimeString();
            c.innerHTML += `<div><span style="color: #58a6ff">[${d}]</span> ${msg}</div>`;
            c.scrollTop = c.scrollHeight;
        }

        async function startBot() {
            const mode = document.getElementById('modeSelect').value;
            const s1 = document.getElementById('symbol1').value;
            const symbols = [s1];
            if (mode === 'DUAL') {
                symbols.push(document.getElementById('symbol2').value);
            }
            
            try {
                log(`Starting ${mode} mode for ${symbols.join(', ')}...`);
                const res = await fetch(API + '/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ mode, symbols })
                });
                const data = await res.json();
                log(data.message);
                fetchStatus();
            } catch (e) { log('Error starting bot'); }
        }

        async function stopBot() {
            try {
                await fetch(API + '/stop', { method: 'POST' });
                log('Stop command sent.');
                fetchStatus();
            } catch (e) { log('Error stopping'); }
        }

        // Main Loop
        async function fetchStatus() {
            try {
                const res = await fetch(API + '/status');
                const data = await res.json();
                
                // 1. Bot State
                const stateEl = document.getElementById('botState');
                if (data.is_running) {
                    stateEl.innerHTML = 'üü¢ ÈÅãË°å‰∏≠ (Running)';
                    stateEl.style.color = 'var(--success)';
                } else {
                    stateEl.innerHTML = 'üî¥ Â∑≤ÂÅúÊ≠¢ (Stopped)';
                    stateEl.style.color = 'var(--danger)';
                }
                
                // 2. Portfolio
                const pnl = parseFloat(data.pnl.current);
                const daily = parseFloat(data.pnl.daily_realized);
                const pnlEl = document.getElementById('pnl-val');
                const navEl = document.getElementById('nav-val');
                
                pnlEl.textContent = (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + ' USDT';
                pnlEl.className = 'stat-value ' + (pnl >= 0 ? 'pnl-positive' : 'pnl-negative');
                
                const dailyEl = document.getElementById('daily-pnl');
                dailyEl.textContent = (daily >= 0 ? '+' : '') + daily.toFixed(2) + ' USDT';
                dailyEl.className = 'stat-value ' + (daily >= 0 ? 'pnl-positive' : 'pnl-negative');

                document.getElementById('bal-usdt').textContent = parseFloat(data.balance.USDT).toFixed(2);
                document.getElementById('nav-val').textContent = parseFloat(data.balance.estimated_nav || 0).toFixed(2) + ' USDT';

                // 3. Active Strategies Render
                const stratCont = document.getElementById('strategy-container');
                if (Object.keys(data.strategies).length > 0) {
                    let html = '';
                    for (const [sym, strat] of Object.entries(data.strategies)) {
                        const price = parseFloat(strat.close || 0);
                        const rsi = parseFloat(strat.rsi || 0);
                        html += `
                        <div style="background: #21262d; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--accent);">
                            <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                                <span style="font-weight:bold; font-size: 16px;">${sym}</span>
                                <span style="color: var(--accent); font-family: monospace;">$${price}</span>
                            </div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                                <div>RSI (14): <span style="font-weight:bold; color: ${rsi < 30 ? 'var(--success)' : (rsi > 70 ? 'var(--danger)' : 'white')}">${rsi.toFixed(1)}</span></div>
                                <div>SMA (20): <span style="color:#8b949e">${parseFloat(strat.sma_20 || 0).toFixed(2)}</span></div>
                                <div>Status: <span style="color:${strat.position_status ? 'var(--warning)' : '#8b949e'}">${strat.position_status || 'Waiting'}</span></div>
                                <div>Action: <span>${strat.next_action.replace('BTC','').replace('/USDT','')}</span></div>
                            </div>
                        </div>`;
                    }
                    stratCont.innerHTML = html;
                } else if (!data.is_running) {
                    stratCont.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Á≠âÂæÖÂïüÂãï...</div>';
                }

                // 4. Scanner Render
                const scanCont = document.getElementById('scanner-list');
                if (data.scanner && data.scanner.length > 0) {
                    let html = '';
                    data.scanner.forEach(coin => {
                        const change = parseFloat(coin.change);
                        html += `
                        <div class="scanner-item">
                            <div>
                                <div style="font-weight: bold; font-size: 14px;">${coin.symbol}</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Vol: ${(coin.volume/1000000).toFixed(1)}M</div>
                            </div>
                            <div style="text-align:right;">
                                <div class="change-badge" style="background: ${change >= 0 ? 'rgba(46, 160, 67, 0.2)' : 'rgba(218, 54, 51, 0.2)'}; color: ${change >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                    ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
                                </div>
                                <div style="font-size: 12px; margin-top: 2px;">$${parseFloat(coin.price)}</div>
                            </div>
                        </div>`;
                    });
                    scanCont.innerHTML = html;
                } else {
                    scanCont.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Scanning Market...</div>';
                }

                // 5. Trades
                const tbody = document.querySelector('#trades-table tbody');
                let rows = '';
                data.trades.forEach(t => {
                    rows += `<tr>
                        <td>${new Date(t.time).toLocaleTimeString()}</td>
                        <td style="color: var(--accent)">${t.symbol}</td>
                        <td class="${t.side === 'BUY' ? 'pnl-positive' : 'pnl-negative'}">${t.side}</td>
                        <td>${t.price}</td>
                        <td>${t.amount}</td>
                    </tr>`;
                });
                tbody.innerHTML = rows;
                
                // 6. Chart
                updateChart(data.pnl.history);

            } catch (e) {
                console.error(e);
            }
        }
        
        function updateChart(history) {
            if (!history || history.length === 0) return;
            const ctx = document.getElementById('pnlChart').getContext('2d');
            
            const labels = history.map(d => new Date(d.time * 1000).toLocaleTimeString());
            const data = history.map(d => d.value);
            
            if (pnlChart) {
                pnlChart.data.labels = labels;
                pnlChart.data.datasets[0].data = data;
                pnlChart.update('none');
            } else {
                pnlChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'PnL (USDT)',
                            data: data,
                            borderColor: '#2ea043',
                            backgroundColor: 'rgba(46, 160, 67, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
                        }
                    }
                });
            }
        }

        // Init
        setInterval(fetchStatus, 2000);
        setInterval(() => {
            document.getElementById('clock').textContent = new Date().toLocaleTimeString();
        }, 1000);
        fetchStatus();
    </script>
</body>
</html>